{% extends "base.html" %}

{% block title %}Quotes Content Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Quotes Content Manager</h1>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Manage Quotes</h5>
        <div>
            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="window.location.reload();">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button type="button" class="btn btn-success btn-sm" disabled>
                <i class="bi bi-plus-circle me-1"></i> Add New Quote (Soon)
            </button>
        </div>
    </div>
    <div class="card-body">
        <p class="text-muted small">
            Manage quotes from <code>input_quotes.json</code>. Status of media files in:<br>
            Images: <code id="image-dir-path" data-path="{{ image_upload_path }}">{{ image_dir }}</code><br>
            Audio: <code id="audio-dir-path" data-path="{{ audio_upload_path }}">{{ audio_dir }}</code>
        </p>

        {% if error_message %}
        <div class="alert alert-danger" role="alert">
            {{ error_message }}
        </div>
        {% endif %}

        <div id="upload-status" class="mb-3"></div>

        {% if not base_names and not error_message %}
        <div class="alert alert-info" role="alert">
            No quotes found in the JSON file. Add entries manually or use the upload feature below.
        </div>
        {% else %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm align-middle">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col" style="min-width: 250px;">Quote</th>
                        <th scope="col">Author</th>
                        <th scope="col">Image</th>
                        <th scope="col">Audio</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for base_name in base_names %}
                    {% set data = quotes_data[base_name] %}
                    <tr id="row-{{ base_name }}">
                        <th scope="row">{{ base_name }}</th>
                        <td>{{ data.quote | truncate(80) }}</td>
                        <td>{{ data.author }}</td>
                        <td class="status-cell image-status">
                            {% if data.image_exists %}
                                <img src="{{ url_for('serve_quote_image', filename=base_name + '.png') }}"
                                     alt="Preview {{ base_name }}"
                                     width="60" height="auto"
                                     style="object-fit: contain; cursor: pointer; border-radius: 4px;"
                                     loading="lazy"
                                     onclick="window.open(this.src)">
                            {% else %}
                                <span class="badge bg-danger">Missing ❌</span>
                            {% endif %}
                        </td>
                         <td class="status-cell audio-status">
                            {% if data.audio_exists %}
                                <audio controls preload="metadata" style="max-width: 150px;">
                                    <source src="{{ url_for('serve_quote_audio', filename=base_name + '.mp3') }}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                            {% else %}
                                <span class="badge bg-danger">Missing ❌</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" disabled title="Edit Text (Coming Soon)"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" disabled title="Delete (Coming Soon)"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <hr>
        <h5 class="mt-4">Upload Media Files</h5>
        <p class="text-muted small">Upload image (.png) and audio (.mp3) files, named like <code>001.png</code>, <code>001.mp3</code> etc. Duplicates will be ignored.</p>

        <div class="row">
            <div class="col-md-6 mb-3">
                <h6>Image Files (.png)</h6>
                <div id="drop-zone-image" class="drop-zone"> <i class="bi bi-file-earmark-image"></i>
                    <p class="mb-0">Drag & Drop Image Files Here</p>
                </div>
                <input type="file" id="image-upload-input" class="form-control form-control-sm mt-2" accept=".png" multiple>
            </div>
            <div class="col-md-6 mb-3">
                 <h6>Audio Files (.mp3)</h6>
                 <div id="drop-zone-audio" class="drop-zone"> <i class="bi bi-file-earmark-music"></i>
                    <p class="mb-0">Drag & Drop Audio Files Here</p>
                 </div>
                 <input type="file" id="audio-upload-input" class="form-control form-control-sm mt-2" accept=".mp3" multiple>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- Configuration ---
    const imageDropZone = document.getElementById('drop-zone-image');
    const audioDropZone = document.getElementById('drop-zone-audio');
    const imageFileInput = document.getElementById('image-upload-input');
    const audioFileInput = document.getElementById('audio-upload-input');
    const uploadStatusDiv = document.getElementById('upload-status');
    const uploadUrl = "{{ url_for('upload_quote_files') }}";
    // Get target paths from data attributes set in HTML
    const imageUploadPath = document.getElementById('image-dir-path')?.getAttribute('data-path');
    const audioUploadPath = document.getElementById('audio-dir-path')?.getAttribute('data-path');

    // --- Helper Functions ---
    function displayUploadStatus(message, isError = false) {
        const alertClass = isError ? 'alert-danger' : 'alert-success';
        // Simple append for now, could get complex with many files
        uploadStatusDiv.innerHTML += `<div class="alert ${alertClass} alert-dismissible fade show small py-2" role="alert">
            ${message}
            <button type="button" class="btn-close py-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
    }

    function uploadFile(file, uploadType) {
        if (!imageUploadPath || !audioUploadPath) {
             displayUploadStatus("Configuration Error: Upload paths not found.", true);
             return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', uploadType);
        formData.append('image_dir', imageUploadPath); // Send paths to backend
        formData.append('audio_dir', audioUploadPath);

        console.log(`Uploading ${file.name} as ${uploadType}`);

        fetch(uploadUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Upload response:', data);
            if (data.success) {
                displayUploadStatus(data.message || `Uploaded ${data.filename}`, false);
                // Optionally: Update table status dynamically (more complex)
                // For now, rely on refresh button
            } else {
                displayUploadStatus(`Error uploading ${file.name}: ${data.error}`, true);
            }
        })
        .catch(error => {
            console.error('Upload fetch error:', error);
            displayUploadStatus(`Network or Server Error uploading ${file.name}. Check console.`, true);
        });
    }

    function handleFiles(files, uploadType) {
        // Clear previous status messages
        uploadStatusDiv.innerHTML = '';
        console.log(`Handling ${files.length} files for ${uploadType}`);
        [...files].forEach(file => {
            // Basic client-side check (backend does thorough check)
            const extension = file.name.split('.').pop().toLowerCase();
            if ((uploadType === 'image' && extension === 'png') || (uploadType === 'audio' && extension === 'mp3')) {
                uploadFile(file, uploadType);
            } else {
                 displayUploadStatus(`Skipped ${file.name}: Invalid type for ${uploadType} zone.`, true);
            }
        });
    }

    // --- Event Listeners ---
    function preventDefaults (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    // Add dragover class
    function highlight(e, zone) {
        zone.classList.add('dragover');
    }

    function unhighlight(e, zone) {
        zone.classList.remove('dragover');
    }

    // Drag and Drop for Images
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageDropZone.addEventListener(eventName, preventDefaults, false);
    });
    imageDropZone.addEventListener('dragenter', (e) => highlight(e, imageDropZone), false);
    ['dragleave', 'drop'].forEach(eventName => {
        imageDropZone.addEventListener(eventName, (e) => unhighlight(e, imageDropZone), false);
    });
    imageDropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files, 'image');
    }, false);

     // Drag and Drop for Audio
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        audioDropZone.addEventListener(eventName, preventDefaults, false);
    });
    audioDropZone.addEventListener('dragenter', (e) => highlight(e, audioDropZone), false);
    ['dragleave', 'drop'].forEach(eventName => {
        audioDropZone.addEventListener(eventName, (e) => unhighlight(e, audioDropZone), false);
    });
    audioDropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files, 'audio');
    }, false);


    // File Input Buttons
    imageFileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files, 'image');
        e.target.value = null; // Reset input so same file can be selected again
    }, false);

    audioFileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files, 'audio');
         e.target.value = null; // Reset input
    }, false);

    console.log("Quotes Manager JS loaded.");
</script>
{% endblock %}